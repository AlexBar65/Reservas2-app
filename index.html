<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reservas Temporarias</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>

<style>
/* ======  CSS ====== */
html,body{margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;color:#333}
.header{display:flex;flex-wrap:wrap;align-items:center;gap:8px;background:#2c3e50;color:#ecf0f1;padding:8px 12px}
.property-btn{background:#34495e;color:#ecf0f1;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:.9rem}
.property-btn.active{background:#1abc9c}
.action-btn{background:#2980b9;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:.9rem}
.action-btn.secondary{background:#7f8c8d}
.action-btn.danger{background:#c0392b}
.month-nav{margin-left:auto;display:flex;gap:4px;align-items:center}
.month-label{min-width:120px;text-align:center}
main{padding:10px}
.check-list{background:#fff;border:1px solid #ddd;border-radius:4px;padding:8px;font-size:.9rem;min-height:60px}
.badge{display:inline-block;padding:2px 4px;font-size:.7rem;border-radius:3px;margin-right:4px}
.badge-success{background:#81c784}.badge-danger{background:#e57373;color:#fff}
.calendar{overflow-x:auto;margin-top:15px}
table{border-collapse:collapse;width:100%;table-layout:fixed}
th,td{border:1px solid #ddd;padding:2px;vertical-align:top;font-size:.75rem;height:85px}
th:nth-child(1){background:#f28c8c;color:#fff}
th:nth-child(2){background:#e7b97d;color:#fff}
th:nth-child(3){background:#cfe3a1}
th:nth-child(4){background:#f1e9a1}
th:nth-child(5){background:#a0c1e8}
th:nth-child(6){background:#b79ddb;color:#fff}
th:nth-child(7){background:#cc8bc7;color:#fff}
.date-number{font-weight:bold;font-size:.8rem}
.event{display:block;margin-top:2px;padding:1px 2px;border-radius:3px;line-height:1.1;word-break:break-word}
.status-pending{background:#ffe082}.status-paid{background:#81c784}.status-cancelled{background:#e57373;color:#fff;text-decoration:line-through}
.status-bonif{background-color:#a0e9ff;color:#000;}
.currency-dolares { color: red !important; }
.hidden{display:none !important}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#fff;padding:18px;border-radius:6px;width:90%;max-width:600px;max-height:90vh;overflow:auto}
.modal-content h2{margin-top:0}
.reservation-form{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.reservation-form input,.reservation-form select,.reservation-form textarea{padding:6px;border:1px solid #ccc;border-radius:4px;font-size:.9rem}
.full-width{grid-column:1 / -1}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px;grid-column:1 / -1}
.search-container{display:flex;gap:4px;align-items:center;margin-left:16px;}
.search-container input{padding:4px;border-radius:4px;border:1px solid #7f8c8d;}
.financial-summary{background:#fff;border:1px solid #ddd;border-radius:4px;padding:8px;margin-top:15px;}
.financial-summary h3, .financial-summary h4{margin-top:0; margin-bottom: 8px;}
.financial-summary .summary-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:10px; margin-bottom: 15px;}
.financial-summary .summary-item{background-color:#f9f9f9;padding:8px;border-radius:4px;}
.financial-summary .summary-item strong{display:block;margin-bottom:4px;color:#2c3e50;}
/* === CSS MODIFICADO === */
.event.highlight{background-color: #d8b4fe !important; border: 2px solid #8b5cf6;}
.financial-summary .view-toggle{font-size: 0.8em; font-weight: normal; margin-left: 10px;}
.financial-summary .compact-view{display: flex; align-items: center; gap: 10px; font-size: 0.8em;}
.financial-summary .compact-view select{font-size: 0.9em; padding: 2px;}
.financial-summary .expanded-breakdown-item{font-size:0.7em; display:flex; justify-content:flex-start; align-items:center; flex-wrap:nowrap; padding: 2px; border-bottom: 1px solid #eee;}
.financial-summary .expanded-breakdown-item strong{margin-right: 5px; white-space:nowrap;}
.financial-summary .expanded-breakdown-item span{margin-right: 10px; white-space:nowrap;}
/* === FIN CSS MODIFICADO === */
</style>
</head>
<body>
<header class="header">
  <button class="property-btn active" id="btnBeltran4" onclick="switchCalendar('beltran4')">Beltrán 4º</button>
  <button class="property-btn" id="btnBeltran8" onclick="switchCalendar('beltran8')">Beltrán 8º</button>
  <button class="property-btn" id="btnDirectorio8" onclick="switchCalendar('directorio8')">Directorio 8º</button>

  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Buscar huésped...">
    <button class="action-btn" onclick="handleSearch()">Buscar</button>
    <button class="action-btn secondary" onclick="clearSearch()">Limpiar</button>
  </div>

  <div class="month-nav">
    <button class="action-btn secondary" onclick="changeMonth(-1)">«</button>
    <span id="monthLabel" class="month-label"></span>
    <button class="action-btn secondary" onclick="changeMonth(1)">»</button>
  </div>

  <button class="action-btn" onclick="openModal()">Añadir reserva</button>

  <button id="authBtn" class="action-btn secondary">Iniciar sesión Google</button>
  <button id="signoutBtn" class="action-btn secondary hidden">Cerrar sesión</button>
</header>

<main>
  <h3>Check-ins / Check-outs</h3>
  <div id="checkList" class="check-list"></div>

  <div id="financialSummary" class="financial-summary">
    <h3>Resumen Financiero del Mes</h3>
    <div>
        <label for="exchangeRate">Cotización Dólar:</label>
        <input type="number" id="exchangeRate" value="1300" oninput="calculateFinancialSummary()">
    </div>
    <hr style="margin: 10px 0;">
    <h4>Totales Generales</h4>
    <div class="summary-grid">
        <div class="summary-item"><strong>Ingresos Totales (ARS):</strong> <span id="summaryTotal">0</span></div>
        <div class="summary-item"><strong>Total Cobrado (ARS):</strong> <span id="summaryPaid">0</span></div>
        <div class="summary-item"><strong>Saldo a Cobrar (ARS):</strong> <span id="summaryDue">0</span></div>
    </div>
    <hr style="margin: 10px 0;">
    <h4>
        Desglose por Departamento
        <label class="view-toggle">
            <input type="checkbox" id="viewToggleCheckbox" onchange="calculateFinancialSummary()"> Ver todos
        </label>
    </h4>
    <div id="summaryByProperty">
        <!-- El contenido se generará dinámicamente con JavaScript -->
    </div>
  </div>

  <div class="calendar">
    <div id="cal-beltran4"></div>
    <div id="cal-beltran8" class="hidden"></div>
    <div id="cal-directorio8" class="hidden"></div>
  </div>
</main>

<footer style="text-align:right;padding:8px">
  <button class="action-btn" onclick="exportData()">Exportar CSV</button>
</footer>

<div id="modalOverlay" class="modal-overlay hidden">
  <div class="modal-content">
    <h2 id="modalTitle">Nueva reserva</h2>
    <form id="reservationForm" class="reservation-form">
      <select id="propertySelect" required class="full-width">
        <option value="beltran4">Beltrán 4º</option>
        <option value="beltran8">Beltrán 8º</option>
        <option value="directorio8">Directorio 8º</option>
      </select>
      
      <input id="guestName" list="clientsDatalist" placeholder="Nombre del huésped" required class="full-width" oninput="handleClientAutocomplete()">
      <datalist id="clientsDatalist"></datalist>
      
      <input id="guestDni" placeholder="DNI" />
      <input id="guestEmail" type="email" placeholder="Email" />
      <input id="guestPhone1" placeholder="Teléfono 1" />
      <input id="guestPhone2" placeholder="Teléfono 2" />
      
      <input id="numGuests" type="number" min="1" placeholder="Cantidad de personas" required />
      <input id="checkInDate" type="date" required />
      <input id="checkOutDate" type="date" required />
      
      <select id="platformSelect" required>
        <option value="AirBnB">AirBnB</option>
        <option value="Booking">Booking</option>
        <option value="Mercado Libre">Mercado Libre</option>
        <option value="Alquiler argentino">Alquiler argentino</option>
        <option value="Para Irnos">Para Irnos</option>
        <option value="x Fuera">x Fuera</option>
        <option value="Otra" selected>Otra</option>
      </select>
      <select id="currencySelect" required>
        <option value="Pesos Argentinos" selected>Pesos Argentinos</option>
        <option value="Dolares">Dolares</option>
      </select>
      
      <input id="totalAmount" type="number" step="0.01" placeholder="Monto total" required oninput="calculateDueAmount()" />
      <input id="paidAmount" type="number" step="0.01" placeholder="Monto pagado/seña" required oninput="calculateDueAmount()" />
      <input id="dueAmount" type="number" step="0.01" placeholder="A pagar al ingreso" readonly />
      <select id="statusSelect">
        <option value="pending">Pendiente</option>
        <option value="paid">Pagado</option>
        <option value="cancelled">Cancelada</option>
      </select>
      
      <textarea id="notes" placeholder="Notas adicionales..." class="full-width"></textarea>
      
      <input type="hidden" id="reservationId" />
      <div class="modal-actions">
        <button id="deleteBtn" class="action-btn danger hidden" onclick="handleDelete()">Eliminar</button>
        <button class="action-btn secondary" onclick="closeModal()">Cerrar</button>
        <button class="action-btn" onclick="handleSave()">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ======  JS ====== */

// --- CONFIGURACIÓN ---
const CLIENT_ID = '110876200467-qdh6su18s906eb6tmvgkp50hkcl0d03q.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBO1S93xy3zDupP-tw1K9dCXhnq6_sQ5MU';
const RESERVAS_FILE_ID = '1sJoANbvCHafpR5VRVmIC1kUCZfWpQcrP';
const CLIENTS_FILE_ID = '1QlDIDNyRT8rIIiY5d8pmGvf4C3QVmiZ5';
const SCOPES = 'https://www.googleapis.com/auth/drive';

let tokenClient;
let gapiInited = false;
let gisInited = false;

const authBtn = document.getElementById('authBtn');
const signoutBtn = document.getElementById('signoutBtn');

// --- LÓGICA DE LA APLICACIÓN ---
const props = ['beltran4', 'beltran8', 'directorio8'];
const propNames = {
    beltran4: 'Beltrán 4º',
    beltran8: 'Beltrán 8º',
    directorio8: 'Directorio 8º'
};
let reservas = JSON.parse(localStorage.getItem('reservas') || '[]');
let clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
let highlightedIds = [];
let y = new Date().getFullYear(), m = new Date().getMonth();
const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

function monthLabel() { document.getElementById('monthLabel').textContent = monthNames[m] + ' ' + y; }

function genGrid(Y, M) {
 const first=new Date(Y,M,1), last=new Date(Y,M+1,0);
 const start=((first.getDay()+6)%7), days=last.getDate(), out=[];
 let week=Array(7).fill(null),d=1;
 for(let i=0;i<7;i++){if(i>=start)week[i]=new Date(Y,M,d++);}
 out.push(week);
 while(d<=days){week=Array(7).fill(null);for(let i=0;i<7&&d<=days;i++)week[i]=new Date(Y,M,d++);out.push(week);}
 while(out.length<6)out.push(Array(7).fill(null));
 return out;
}

function render(prop) {
    const cont = document.getElementById('cal-' + prop);
    cont.innerHTML = '';
    const tbl = document.createElement('table');
    tbl.innerHTML = '<thead><tr>' + ['Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa', 'Do'].map(d => `<th>${d}</th>`).join('') + '</tr></thead>';
    const tbody = document.createElement('tbody');
    genGrid(y, m).forEach(week => {
        const tr = document.createElement('tr');
        week.forEach(day => {
            const td = document.createElement('td');
            if (day) {
                td.innerHTML = `<div class="date-number">${day.getDate()}</div>`;
                const ds = day.toISOString().split('T')[0];
                reservas.filter(r => r.property === prop && ds >= r.checkIn && ds <= r.checkOut)
                    .forEach(r => {
                        const ev = document.createElement('div');
                        const platformInfo = r.platform || 'Otra';
                        
                        if (r.total === 0) {
                            ev.className = 'event status-bonif';
                            ev.textContent = `${r.guestName} (${platformInfo}) ${r.numGuests}p (Bonif/Sorteo/Regalo)`;
                        } else {
                            ev.className = `event status-${r.status}`;
                            let currencyIndicator = r.currency === 'Dolares' ? ' (Dol)' : '';
                            ev.textContent = `${r.guestName} (${platformInfo}) ${r.numGuests}p, Total: ${r.total}, Pagado: ${r.paid}, Saldo: ${r.due}${currencyIndicator}`;
                        }

                        if (r.currency === 'Dolares') ev.classList.add('currency-dolares');
                        if (highlightedIds.includes(r.id)) ev.classList.add('highlight');
                        
                        ev.onclick = e => { e.stopPropagation(); openEdit(r.id); };
                        ev.title = r.notes || 'Sin notas adicionales';
                        td.appendChild(ev);
                    });
                td.onclick = () => openModal({ property: prop, date: ds });
            }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
    cont.appendChild(tbl);
}

function renderAll(){props.forEach(render);refreshList();monthLabel();calculateFinancialSummary();}
function switchCalendar(p){props.forEach(pr=>{
 document.getElementById('cal-'+pr).classList.toggle('hidden',pr!==p);
 document.getElementById(pr==='beltran4'?'btnBeltran4':pr==='beltran8'?'btnBeltran8':'btnDirectorio8')
   .classList.toggle('active',pr===p);
});}
function changeMonth(delta){m+=delta;if(m<0){m=11;y--;}else if(m>11){m=0;y++;}renderAll();}

function refreshList() {
    const list = document.getElementById('checkList'); list.innerHTML = '';
    const today = new Date(); today.setHours(0,0,0,0);
    const tomorrow = new Date(today); tomorrow.setDate(today.getDate()+1);
    const yesterday = new Date(today); yesterday.setDate(today.getDate()-1);
    const todayStr = today.toISOString().split('T')[0];
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    const yesterdayStr = yesterday.toISOString().split('T')[0];
    const checkInsToday = reservas.filter(r => r.checkIn === todayStr && r.status !== 'cancelled');
    const checkOutsToday = reservas.filter(r => r.checkOut === yesterdayStr && r.status !== 'cancelled');
    const todaySection = document.createElement('div');
    todaySection.innerHTML = `<strong>Hoy (${todayStr})</strong><br>`;
    if (checkInsToday.length === 0 && checkOutsToday.length === 0) {
        todaySection.innerHTML += 'Sin movimientos';
    } else {
        if (checkInsToday.length > 0) todaySection.innerHTML += `<span class="badge badge-success">Check-in</span> ${checkInsToday.map(r => `${r.guestName} (${r.property})`).join(', ')}<br>`;
        if (checkOutsToday.length > 0) todaySection.innerHTML += `<span class="badge badge-danger">Check-out</span> ${checkOutsToday.map(r => `${r.guestName} (${r.property})`).join(', ')}`;
    }
    list.appendChild(todaySection);
    const checkInsTomorrow = reservas.filter(r => r.checkIn === tomorrowStr && r.status !== 'cancelled');
    const checkOutsTomorrow = reservas.filter(r => r.checkOut === todayStr && r.status !== 'cancelled');
    const tomorrowSection = document.createElement('div');
    tomorrowSection.innerHTML = `<br><strong>Mañana (${tomorrowStr})</strong><br>`;
    if (checkInsTomorrow.length === 0 && checkOutsTomorrow.length === 0) {
        tomorrowSection.innerHTML += 'Sin movimientos';
    } else {
        if (checkInsTomorrow.length > 0) tomorrowSection.innerHTML += `<span class="badge badge-success">Check-in</span> ${checkInsTomorrow.map(r => `${r.guestName} (${r.property})`).join(', ')}<br>`;
        if (checkOutsTomorrow.length > 0) tomorrowSection.innerHTML += `<span class="badge badge-danger">Check-out</span> ${checkOutsTomorrow.map(r => `${r.guestName} (${r.property})`).join(', ')}`;
    }
    list.appendChild(tomorrowSection);
}

function calculateDueAmount() {
    const total = parseFloat(document.getElementById('totalAmount').value) || 0;
    const paid = parseFloat(document.getElementById('paidAmount').value) || 0;
    const due = total - paid;
    document.getElementById('dueAmount').value = due.toFixed(2);
}

function openModal(pref) {
    document.getElementById('modalOverlay').classList.remove('hidden');
    document.getElementById('reservationForm').reset();
    document.getElementById('reservationId').value = '';
    document.getElementById('deleteBtn').classList.add('hidden');
    if (pref) {
        propertySelect.value = pref.property;
        checkInDate.value = pref.date;
        checkOutDate.value = pref.date;
    }
    document.getElementById('modalTitle').textContent = 'Nueva reserva';
    populateClientsDatalist();
    calculateDueAmount(); 
}

function closeModal() { document.getElementById('modalOverlay').classList.add('hidden'); }

function openEdit(id) {
    const r = reservas.find(x => x.id === id);
    if (!r) return;
    document.getElementById('reservationForm').reset();
    populateClientsDatalist();
    
    document.getElementById('modalTitle').textContent = 'Editar reserva';
    propertySelect.value = r.property;
    guestName.value = r.guestName;
    guestDni.value = r.guestDni || '';
    guestEmail.value = r.guestEmail || '';
    guestPhone1.value = r.guestPhone1 || '';
    guestPhone2.value = r.guestPhone2 || '';
    numGuests.value = r.numGuests;
    checkInDate.value = r.checkIn;
    checkOutDate.value = r.checkOut;
    platformSelect.value = r.platform || 'Otra';
    currencySelect.value = r.currency || 'Pesos Argentinos';
    totalAmount.value = r.total;
    paidAmount.value = r.paid;
    statusSelect.value = r.status;
    notes.value = r.notes || '';
    reservationId.value = r.id;
    
    calculateDueAmount();
    
    document.getElementById('deleteBtn').classList.remove('hidden');
    document.getElementById('modalOverlay').classList.remove('hidden');
}

function handleDelete() {
    const id = document.getElementById('reservationId').value;
    if (id && confirm('¿Eliminar la reserva?')) {
        reservas = reservas.filter(r => r.id !== id);
        save();
        renderAll();
        closeModal();
    }
}

function exportData() {
    if (!reservas.length) { alert('No hay datos'); return; }
    const csv = ['ID,Propiedad,Nombre,DNI,Email,Tel1,Tel2,Pers,Ingreso,Egreso,Plataforma,Moneda,Total,Pago,IngresoPend,Estado,Notas'];
    reservas.forEach(r => csv.push([
        r.id, r.property, r.guestName, r.guestDni || '', r.guestEmail || '', r.guestPhone1 || '', r.guestPhone2 || '',
        r.numGuests, r.checkIn, r.checkOut, r.platform || 'Otra', r.currency || 'Pesos Argentinos',
        r.total, r.paid, r.due, r.status, `"${(r.notes || '').replace(/"/g, '""')}"`
    ].join(',')));
    const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'reservas.csv'; a.click(); URL.revokeObjectURL(url);
}

function handleClientAutocomplete() {
    const name = document.getElementById('guestName').value;
    const client = clientes.find(c => c.name.toLowerCase() === name.toLowerCase());
    if (client) {
        document.getElementById('guestDni').value = client.dni || '';
        document.getElementById('guestEmail').value = client.email || '';
        document.getElementById('guestPhone1').value = client.phone1 || '';
        document.getElementById('guestPhone2').value = client.phone2 || '';
    }
}

function populateClientsDatalist() {
    const datalist = document.getElementById('clientsDatalist');
    datalist.innerHTML = '';
    const uniqueNames = [...new Set(clientes.map(c => c.name))];
    uniqueNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        datalist.appendChild(option);
    });
}

// =================================================================
// ========= FUNCIÓN MODIFICADA PARA RESUMEN FINANCIERO ============
// =================================================================
function formatNumber(num) {
    return Math.round(num).toLocaleString('es-AR');
}

function calculateFinancialSummary() {
    const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 1;
    const firstDayOfMonth = new Date(y, m, 1);
    const lastDayOfMonth = new Date(y, m + 1, 0);

    let grandTotal = { total: 0, paid: 0, due: 0 };
    const byProperty = {};
    props.forEach(prop => { byProperty[prop] = { total: 0, paid: 0, due: 0 }; });

    reservas.filter(r => {
        const checkIn = new Date(r.checkIn + 'T00:00:00');
        return checkIn >= firstDayOfMonth && checkIn <= lastDayOfMonth && r.status !== 'cancelled';
    }).forEach(r => {
        const rate = r.currency === 'Dolares' ? exchangeRate : 1;
        const currentTotal = r.total * rate;
        const currentPaid = r.paid * rate;
        const currentDue = r.due * rate;

        grandTotal.total += currentTotal;
        grandTotal.paid += currentPaid;
        grandTotal.due += currentDue;

        if (byProperty[r.property]) {
            byProperty[r.property].total += currentTotal;
            byProperty[r.property].paid += currentPaid;
            byProperty[r.property].due += currentDue;
        }
    });

    document.getElementById('summaryTotal').textContent = formatNumber(grandTotal.total);
    document.getElementById('summaryPaid').textContent = formatNumber(grandTotal.paid);
    document.getElementById('summaryDue').textContent = formatNumber(grandTotal.due);

    const breakdownContainer = document.getElementById('summaryByProperty');
    const showAll = document.getElementById('viewToggleCheckbox').checked;
    
    breakdownContainer.innerHTML = '';

    if (showAll) {
        props.forEach(prop => {
            const propData = byProperty[prop];
            const propElement = document.createElement('div');
            propElement.className = 'expanded-breakdown-item';
            propElement.innerHTML = `
                <strong>${propNames[prop]}:</strong>
                <span>Ingresos: ${formatNumber(propData.total)}</span>
                <span>Cobrado: ${formatNumber(propData.paid)}</span>
                <span>Saldo: ${formatNumber(propData.due)}</span>
            `;
            breakdownContainer.appendChild(propElement);
        });
    } else {
        const selectedProp = document.getElementById('summaryPropSelect')?.value || props[0];
        const propData = byProperty[selectedProp];

        breakdownContainer.innerHTML = `
            <div class="compact-view">
                <select id="summaryPropSelect" onchange="calculateFinancialSummary()">
                    ${props.map(p => `<option value="${p}" ${p === selectedProp ? 'selected' : ''}>${propNames[p]}</option>`).join('')}
                </select>
                <span><strong>Ingresos:</strong> ${formatNumber(propData.total)}</span>
                <span><strong>Cobrado:</strong> ${formatNumber(propData.paid)}</span>
                <span><strong>Saldo:</strong> ${formatNumber(propData.due)}</span>
            </div>
        `;
    }
}
// =================================================================
// =================== FIN DE LA FUNCIÓN MODIFICADA ==================
// =================================================================

function handleSearch() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    if (!query) return;
    highlightedIds = reservas
        .filter(r => r.guestName.toLowerCase().includes(query))
        .map(r => r.id);
    if(highlightedIds.length === 0) alert('No se encontraron reservas para ese huésped.');
    renderAll();
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    highlightedIds = [];
    renderAll();
}

// --- LÓGICA DE AUTENTICACIÓN Y DATOS DE GOOGLE ---
function gapiLoaded() { gapi.load('client', initializeGapiClient); }
function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '',
    });
    gisInited = true;
    maybeEnableAuthButtons();
}
async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
    });
    gapiInited = true;
    maybeEnableAuthButtons();
}
function maybeEnableAuthButtons() {
    if (gapiInited && gisInited) {
        authBtn.onclick = handleAuthClick;
        signoutBtn.onclick = handleSignoutClick;
    }
}
function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) { throw (resp); }
        updateSigninStatus(true);
        await Promise.all([loadReservasData(), loadClientsData()]);
    };
    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
    } else {
        tokenClient.requestAccessToken({ prompt: '' });
    }
}
function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        updateSigninStatus(false);
    }
}
function updateSigninStatus(isSignedIn) {
    if (isSignedIn) {
        authBtn.classList.add('hidden');
        signoutBtn.classList.remove('hidden');
    } else {
        authBtn.classList.remove('hidden');
        signoutBtn.classList.add('hidden');
        reservas = [];
        clientes = [];
        renderAll();
    }
}

async function loadReservasData() {
    try {
        const response = await gapi.client.drive.files.get({ fileId: RESERVAS_FILE_ID, alt: 'media' });
        let data = JSON.parse(response.body);
        if (!Array.isArray(data)) data = [];
        reservas = data.map(r => ({
            ...r,
            platform: r.platform || 'Otra',
            currency: r.currency || 'Pesos Argentinos'
        }));
        localStorage.setItem('reservas', JSON.stringify(reservas));
        renderAll();
    } catch (err) { console.error("Error al cargar reservas: ", err); }
}

async function loadClientsData() {
    try {
        const response = await gapi.client.drive.files.get({ fileId: CLIENTS_FILE_ID, alt: 'media' });
        let data = JSON.parse(response.body);
        if (!Array.isArray(data)) data = [];
        clientes = data;
        localStorage.setItem('clientes', JSON.stringify(clientes));
        populateClientsDatalist();
    } catch (err) { console.error("Error al cargar clientes: ", err); }
}

async function saveData(fileId, data) {
    if (gapi.client.getToken()) {
        const content = JSON.stringify(data, null, 2);
        try {
            await gapi.client.request({
                path: '/upload/drive/v3/files/' + fileId,
                method: 'PATCH',
                params: { uploadType: 'media' },
                body: content,
            });
        } catch (err) { console.error("Error al guardar en Drive: ", err); }
    }
}

async function save() {
    localStorage.setItem('reservas', JSON.stringify(reservas));
    localStorage.setItem('clientes', JSON.stringify(clientes));
    await Promise.all([
        saveData(RESERVAS_FILE_ID, reservas),
        saveData(CLIENTS_FILE_ID, clientes)
    ]);
}

async function handleSave() {
    const id = document.getElementById('reservationId').value;
    const isNew = !id;

    calculateDueAmount();

    const newReservation = {
        id: id || 'res-' + Math.random().toString(36).slice(2),
        property: propertySelect.value,
        guestName: guestName.value.trim(),
        guestDni: guestDni.value.trim(),
        guestEmail: guestEmail.value.trim(),
        guestPhone1: guestPhone1.value.trim(),
        guestPhone2: guestPhone2.value.trim(),
        numGuests: +numGuests.value,
        checkIn: checkInDate.value,
        checkOut: checkOutDate.value,
        platform: platformSelect.value,
        currency: currencySelect.value,
        total: +totalAmount.value,
        paid: +paidAmount.value,
        due: +dueAmount.value,
        status: statusSelect.value,
        notes: notes.value.trim()
    };

    if (!newReservation.guestName || !newReservation.checkIn || !newReservation.checkOut) {
        alert('Faltan campos obligatorios: Nombre, Ingreso y Egreso.'); return;
    }
    const today = new Date().toISOString().split('T')[0];
    if (isNew && newReservation.checkIn < today) {
        alert('No se puede crear una reserva con fecha de ingreso en el pasado.'); return;
    }
    if (new Date(newReservation.checkOut) < new Date(newReservation.checkIn)) {
        alert('La fecha de egreso debe ser igual o posterior a la de ingreso.'); return;
    }
    if (newReservation.numGuests < 1) {
        alert('La cantidad de personas debe ser al menos 1.'); return;
    }
    if (newReservation.total < 0 || newReservation.paid < 0) {
        alert('Los montos no pueden ser negativos.'); return;
    }
    if (newReservation.paid > newReservation.total) {
        alert('El monto pagado no puede ser mayor al monto total.'); return;
    }
    
    if (isNew && newReservation.total === 0) {
        newReservation.paid = 0; newReservation.due = 0; newReservation.status = 'paid';
    } else if (!isNew && newReservation.total <= 0) {
        alert('En una modificación, el monto total no puede ser cero o negativo.'); return;
    }
    
    if (newReservation.paid >= newReservation.total && newReservation.status !== 'cancelled') {
        newReservation.status = 'paid';
    }

    const newStart = new Date(newReservation.checkIn + 'T00:00:00');
    const newEnd = new Date(newReservation.checkOut + 'T00:00:00');
    if (reservas.some(ex => ex.property === newReservation.property && ex.id !== newReservation.id && ex.status !== 'cancelled' && newStart <= new Date(ex.checkOut + 'T00:00:00') && new Date(ex.checkIn + 'T00:00:00') <= newEnd)) {
        alert('Error: Las fechas se superponen con una reserva activa.'); return;
    }

    const resIndex = reservas.findIndex(x => x.id === newReservation.id);
    if (resIndex > -1) { reservas[resIndex] = newReservation; } else { reservas.push(newReservation); }

    const clientIndex = clientes.findIndex(c => c.name.toLowerCase() === newReservation.guestName.toLowerCase());
    if (clientIndex > -1) {
        clientes[clientIndex] = { ...clientes[clientIndex], ...{
            dni: newReservation.guestDni, email: newReservation.guestEmail, 
            phone1: newReservation.guestPhone1, phone2: newReservation.guestPhone2
        }};
    } else {
        clientes.push({
            name: newReservation.guestName, dni: newReservation.guestDni, email: newReservation.guestEmail,
            phone1: newReservation.guestPhone1, phone2: newReservation.guestPhone2
        });
    }

    await save();
    renderAll();
    populateClientsDatalist();
    closeModal();
}

// --- INICIALIZACIÓN ---
window.switchCalendar=switchCalendar;
window.openModal=openModal;
window.closeModal=closeModal;
window.handleSave=handleSave;
window.handleDelete=handleDelete;
window.changeMonth=changeMonth;
window.exportData = exportData;
window.calculateDueAmount = calculateDueAmount; 
window.handleClientAutocomplete = handleClientAutocomplete;
window.handleSearch = handleSearch;
window.clearSearch = clearSearch;
window.calculateFinancialSummary = calculateFinancialSummary;

function gapiLoadedWrapper() { gapiLoaded(); }
function gisLoadedWrapper() { gisLoaded(); }

monthLabel();
renderAll();
switchCalendar('beltran4');

const gapiScript = document.querySelector('script[src="https://apis.google.com/js/api.js"]');
gapiScript.onload = gapiLoadedWrapper;
const gisScript = document.querySelector('script[src="https://accounts.google.com/gsi/client"]');
gisScript.onload = gisLoadedWrapper;

</script>
</body>
</html>


